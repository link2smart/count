<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Smart Trésorerie (Gemini AI)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PDF.js (Nouvelle librairie pour l'extraction locale) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configuration du Worker PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; -webkit-print-color-adjust: exact; }
            @page { margin: 0.5cm; size: landscape; }
            .break-inside-avoid { break-inside: avoid; }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans min-h-screen">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONES SVG ---
        const IconBase = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Icons = {
            Key: (p) => <IconBase {...p}><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></IconBase>,
            Upload: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>,
            FileText: (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></IconBase>,
            Loader: (p) => <IconBase {...p}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>,
            Check: (p) => <IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>,
            Alert: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>,
            Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>,
            Refresh: (p) => <IconBase {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>,
            CreditCard: (p) => <IconBase {...p}><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></IconBase>,
            Brain: (p) => <IconBase {...p}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></IconBase>,
            Settings: (p) => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>
        };

        // --- UTILITAIRES ---
        const parseDate = (dateStr) => {
            if (!dateStr) return null;
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            return new Date(parts[2], parts[1] - 1, parts[0]);
        };
        const formatDate = (date) => date ? date.toLocaleDateString('fr-FR') : '-';
        const formatCurrency = (amount) => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(amount);

        // --- NOUVEAU MOTEUR D'EXTRACTION (LOCAL) ---
        const extractTextFromPdf = async (file) => {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            
            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                // On joint les items par un espace pour garder une certaine structure
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += `--- PAGE ${i} ---\n${pageText}\n`;
            }
            return fullText;
        };

        // --- MOTEUR GEMINI (TEXTE -> JSON) ---
        const analyzeTextWithGemini = async (textData, apiKey, modelId) => {
            const prompt = `
                Tu es un expert comptable. Analyse le texte brut extrait d'un Grand Livre Client ci-dessous.
                Extrait TOUTES les lignes de mouvement comptable pertinentes.
                
                Données fournies :
                ${textData.substring(0, 30000)} // Limite pour éviter de casser le prompt si trop long

                Instructions :
                1. Repère les lignes contenant une date, un libellé et un montant.
                2. Ignore les totaux, sous-totaux et reports à nouveau non datés.
                3. Identifie bien les colonnes DÉBIT et CRÉDIT.
                4. Pour le "Lettrage", cherche des codes courts (A, B, AA...) souvent en fin de ligne ou près du montant.
                5. Renvoie UNIQUEMENT un tableau JSON valide.

                Format JSON attendu pour chaque ligne :
                {
                    "date": "JJ/MM/AAAA",
                    "libelle": "string",
                    "piece": "string (numéro facture/pièce)",
                    "lettre": "string (laisser vide si absent)",
                    "echeance": "JJ/MM/AAAA (si absente, mettre date opération)",
                    "debit": number (0 si crédit),
                    "credit": number (0 si débit)
                }
            `;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || `Erreur API (${response.status})`);
            }

            const result = await response.json();
            const textResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!textResponse) throw new Error("Réponse vide de l'IA");

            // Nettoyage des balises markdown json
            const jsonStr = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
            
            // Tentative de parsing
            try {
                return JSON.parse(jsonStr);
            } catch (e) {
                console.error("Erreur parsing JSON:", jsonStr);
                throw new Error("L'IA a renvoyé un format invalide. Réessayez.");
            }
        };

        // --- COMPOSANT PRINCIPAL ---
        function App() {
            // État Global
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [selectedModel, setSelectedModel] = useState(localStorage.getItem('gemini_model') || 'gemini-1.5-flash');
            const [step, setStep] = useState(apiKey ? 'upload' : 'login'); 
            const [clientName, setClientName] = useState("Client Inconnu");
            const [payments, setPayments] = useState([]);
            const [filteredPayments, setFilteredPayments] = useState([]);
            const [dateRange, setDateRange] = useState({ start: '2025-01-01', end: '2025-12-31' });
            const [error, setError] = useState(null);
            const [logs, setLogs] = useState("");

            // Modèles disponibles
            const models = [
                { id: 'gemini-1.5-flash', name: 'Gemini 1.5 Flash (Recommandé)' },
                { id: 'gemini-1.5-flash-latest', name: 'Gemini 1.5 Flash (Latest)' },
                { id: 'gemini-1.5-flash-001', name: 'Gemini 1.5 Flash (Stable)' },
                { id: 'gemini-1.5-pro', name: 'Gemini 1.5 Pro (Plus puissant)' }
            ];

            const handleSaveKey = () => {
                localStorage.setItem('gemini_api_key', apiKey);
                localStorage.setItem('gemini_model', selectedModel);
                setStep('upload');
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setStep('analyzing');
                setLogs("Extraction du texte du PDF en local...");
                setError(null);
                
                const cleanName = file.name.replace('.pdf', '').replace(/_/g, ' ').toUpperCase();
                setClientName(cleanName);

                try {
                    // ÉTAPE 1 : Extraction Locale
                    const pdfText = await extractTextFromPdf(file);
                    
                    if (!pdfText || pdfText.length < 50) {
                        throw new Error("Impossible de lire le texte du PDF. Document scanné ?");
                    }

                    setLogs(`Texte extrait (${pdfText.length} caractères). Analyse IA en cours avec ${selectedModel}...`);

                    // ÉTAPE 2 : Analyse IA du texte
                    const rawData = await analyzeTextWithGemini(pdfText, apiKey, selectedModel);
                    
                    setLogs(`${rawData.length} lignes identifiées. Finalisation...`);
                    
                    const processed = processData(rawData);
                    setPayments(processed);
                    setStep('dashboard');
                } catch (err) {
                    console.error(err);
                    let msg = err.message;
                    if (msg.includes('404')) msg = "Modèle introuvable. Changez de modèle dans les paramètres.";
                    if (msg.includes('403')) msg = "Clé API invalide.";
                    setError(msg);
                    setStep('upload');
                }
            };

            // --- LOGIQUE METIER (inchangée) ---
            const processData = (rawData) => {
                const groups = {};
                const nonLettresFactures = [];
                const nonLettresPaiements = [];

                rawData.forEach(row => {
                    if(!row.lettre) row.lettre = "";
                    if (row.lettre && row.lettre !== "") {
                        if (!groups[row.lettre]) groups[row.lettre] = { factures: [], paiements: [] };
                        if (row.debit > 0) groups[row.lettre].factures.push(row);
                        if (row.credit > 0) groups[row.lettre].paiements.push(row);
                    } else {
                        if (row.debit > 0) nonLettresFactures.push(row);
                        if (row.credit > 0) nonLettresPaiements.push(row);
                    }
                });

                const analyzedPayments = [];

                const processGroup = (factures, paiements) => {
                    factures.sort((a, b) => parseDate(a.date) - parseDate(b.date));
                    paiements.sort((a, b) => parseDate(a.date) - parseDate(b.date));

                    let facturesDispo = factures.map(f => ({ ...f, montantRestant: f.debit, dateObj: parseDate(f.date) }));
                    let fIndex = 0;

                    paiements.forEach(paiement => {
                        let montantDispoPaiement = paiement.credit;
                        const dateSaisie = parseDate(paiement.date);
                        const dateValeur = paiement.echeance ? parseDate(paiement.echeance) : dateSaisie;
                        const invoicesCovered = [];

                        while (montantDispoPaiement > 0.01 && fIndex < facturesDispo.length) {
                            let facture = facturesDispo[fIndex];
                            let montantAlloue = Math.min(montantDispoPaiement, facture.montantRestant);

                            const diffCouverture = dateSaisie - facture.dateObj;
                            const daysCouverture = Math.ceil(diffCouverture / (1000 * 60 * 60 * 24));
                            const diffEncaissement = dateValeur - facture.dateObj;
                            const daysEncaissement = Math.ceil(diffEncaissement / (1000 * 60 * 60 * 24));

                            invoicesCovered.push({
                                piece: facture.piece,
                                dateObj: facture.dateObj,
                                montantRegle: montantAlloue,
                                delaiCouverture: daysCouverture,
                                delaiEncaissement: daysEncaissement
                            });

                            montantDispoPaiement -= montantAlloue;
                            facture.montantRestant -= montantAlloue;
                            if (facture.montantRestant < 0.01) fIndex++;
                        }

                        let totalCoveredAmount = invoicesCovered.reduce((sum, inv) => sum + inv.montantRegle, 0);
                        let avgCouverture = 0;
                        let avgEncaissement = 0;

                        if (totalCoveredAmount > 0) {
                            avgCouverture = invoicesCovered.reduce((sum, inv) => sum + (inv.delaiCouverture * inv.montantRegle), 0) / totalCoveredAmount;
                            avgEncaissement = invoicesCovered.reduce((sum, inv) => sum + (inv.delaiEncaissement * inv.montantRegle), 0) / totalCoveredAmount;
                        }

                        analyzedPayments.push({
                            ...paiement,
                            dateObj: dateSaisie,
                            echeanceObj: dateValeur,
                            invoicesCovered,
                            avgCouverture,
                            avgEncaissement
                        });
                    });
                };

                Object.values(groups).forEach(g => processGroup(g.factures, g.paiements));
                if (nonLettresPaiements.length > 0 && nonLettresFactures.length > 0) {
                    processGroup(nonLettresFactures, nonLettresPaiements);
                }

                return analyzedPayments.sort((a, b) => b.dateObj - a.dateObj);
            };

            useEffect(() => {
                if(payments.length === 0) return;
                const start = new Date(dateRange.start);
                const end = new Date(dateRange.end);
                const filtered = payments.filter(p => p.dateObj >= start && p.dateObj <= end);
                setFilteredPayments(filtered);
            }, [payments, dateRange]);

            const kpis = useMemo(() => {
                const totalAmount = filteredPayments.reduce((acc, curr) => acc + curr.credit, 0);
                if (totalAmount === 0) return { globalCouverture: 0, globalEncaissement: 0, totalAmount: 0, count: 0 };
                const weightedCouverture = filteredPayments.reduce((acc, curr) => acc + (curr.avgCouverture * curr.credit), 0) / totalAmount;
                const weightedEncaissement = filteredPayments.reduce((acc, curr) => acc + (curr.avgEncaissement * curr.credit), 0) / totalAmount;
                return { 
                    globalCouverture: Math.round(weightedCouverture), 
                    globalEncaissement: Math.round(weightedEncaissement), 
                    totalAmount, 
                    count: filteredPayments.length 
                };
            }, [filteredPayments]);

            // --- RENDU ---

            if (step === 'login') {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-slate-900 text-white p-4">
                        <div className="w-full max-w-md p-8 bg-slate-800 rounded-2xl shadow-2xl border border-slate-700">
                            <div className="flex justify-center mb-6 text-indigo-400">
                                <Icons.Brain className="w-16 h-16" />
                            </div>
                            <h1 className="text-2xl font-bold text-center mb-2">Smart Trésorerie</h1>
                            <p className="text-slate-400 text-center text-sm mb-6">
                                Analyse automatique via Google Gemini AI (Lecture Locale).
                            </p>
                            
                            <div className="mb-4">
                                <label className="block text-xs font-semibold uppercase tracking-wider text-slate-500 mb-2">Clé API Gemini</label>
                                <input 
                                    type="password" 
                                    placeholder="Collez votre clé ici (AIza...)"
                                    className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-indigo-500 outline-none"
                                    value={apiKey}
                                    onChange={(e) => setApiKey(e.target.value)}
                                />
                            </div>

                            <div className="mb-6">
                                <label className="block text-xs font-semibold uppercase tracking-wider text-slate-500 mb-2">Modèle IA</label>
                                <select 
                                    value={selectedModel}
                                    onChange={(e) => setSelectedModel(e.target.value)}
                                    className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-indigo-500 outline-none appearance-none"
                                >
                                    {models.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                                </select>
                            </div>

                            <button 
                                onClick={handleSaveKey}
                                disabled={!apiKey}
                                className="w-full bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-3 rounded-lg font-bold transition disabled:opacity-50 flex justify-center items-center"
                            >
                                <Icons.Check className="w-5 h-5 mr-2" />
                                Continuer
                            </button>
                        </div>
                    </div>
                );
            }

            if (step === 'upload') {
                return (
                    <div className="flex items-center justify-center min-h-screen p-4">
                        <div className="w-full max-w-lg p-10 bg-white rounded-2xl shadow-xl border border-slate-100 text-center">
                            <div className="bg-indigo-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                                <Icons.Upload className="w-10 h-10 text-indigo-600" />
                            </div>
                            <h2 className="text-2xl font-bold text-slate-800 mb-2">Analyser un Grand Livre</h2>
                            <p className="text-slate-500 mb-2">Sélectionnez votre fichier PDF.</p>
                            <p className="text-xs text-indigo-500 mb-8 bg-indigo-50 inline-block px-3 py-1 rounded-full">
                                Mode : Extraction texte locale + Analyse IA
                            </p>

                            {error && (
                                <div className="mb-6 p-4 bg-rose-50 text-rose-600 text-sm rounded-lg flex items-start text-left">
                                    <Icons.Alert className="w-5 h-5 mr-3 flex-shrink-0 mt-0.5" />
                                    <div>{error}</div>
                                </div>
                            )}
                            <label className="block w-full cursor-pointer group">
                                <div className="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 group-hover:bg-indigo-700 group-hover:shadow-xl transition flex items-center justify-center">
                                    <Icons.FileText className="w-5 h-5 mr-2" />
                                    Choisir un PDF
                                </div>
                                <input type="file" accept=".pdf" className="hidden" onChange={handleFileUpload} />
                            </label>
                            <button onClick={() => setStep('login')} className="mt-6 text-xs text-slate-400 hover:text-slate-600 underline flex items-center justify-center mx-auto">
                                <Icons.Settings className="w-3 h-3 mr-1" />
                                Paramètres
                            </button>
                        </div>
                    </div>
                );
            }

            if (step === 'analyzing') {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-slate-50">
                        <div className="animate-spin text-indigo-600 mb-4">
                            <Icons.Loader className="w-12 h-12" />
                        </div>
                        <h2 className="text-xl font-semibold text-slate-800 animate-pulse">Analyse en cours...</h2>
                        <p className="text-slate-500 mt-2 text-sm max-w-md text-center">{logs}</p>
                    </div>
                );
            }

            return (
                <div className="max-w-7xl mx-auto p-6">
                    <div className="print-only mb-8 border-b-2 border-slate-800 pb-4">
                        <div className="flex justify-between items-end">
                            <div>
                                <h1 className="text-3xl font-bold text-slate-900">RAPPORT D'ANALYSE TRÉSORERIE</h1>
                                <p className="text-xl font-medium text-slate-700 mt-2">{clientName}</p>
                            </div>
                            <div className="text-right">
                                <p className="text-sm text-slate-500">Généré le {new Date().toLocaleDateString('fr-FR')}</p>
                                <p className="font-mono text-sm mt-1">Période: {formatDate(new Date(dateRange.start))} - {formatDate(new Date(dateRange.end))}</p>
                            </div>
                        </div>
                    </div>

                    <div className="no-print flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                        <div className="flex items-center space-x-3">
                            <div className="bg-indigo-600 p-2 rounded-lg text-white">
                                <Icons.CreditCard className="w-6 h-6" />
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold text-slate-900">Analyse Règlements</h1>
                                <p className="text-sm text-slate-500 font-medium">{clientName}</p>
                            </div>
                        </div>
                        <div className="flex items-center space-x-2 bg-white p-2 rounded-lg shadow-sm border border-slate-200">
                            <Icons.Refresh className="w-4 h-4 text-slate-400 ml-2" />
                            <input type="date" value={dateRange.start} onChange={e => setDateRange({...dateRange, start: e.target.value})} className="border-none text-sm text-slate-600 outline-none w-32 bg-transparent" />
                            <span className="text-slate-300">|</span>
                            <input type="date" value={dateRange.end} onChange={e => setDateRange({...dateRange, end: e.target.value})} className="border-none text-sm text-slate-600 outline-none w-32 bg-transparent" />
                        </div>
                        <div className="flex space-x-2">
                            <button onClick={() => window.print()} className="flex items-center px-4 py-2 bg-slate-800 text-white rounded-lg text-sm hover:bg-slate-700 transition">
                                <Icons.Download className="w-4 h-4 mr-2" /> PDF
                            </button>
                            <button onClick={() => setStep('upload')} className="flex items-center px-4 py-2 bg-indigo-50 text-indigo-700 rounded-lg text-sm hover:bg-indigo-100 transition">
                                Nouveau
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 card-grid">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-indigo-100 break-inside-avoid">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider">Couverture (Commercial)</h3>
                                <div className="p-2 bg-indigo-50 rounded-lg text-indigo-600"><Icons.FileText className="w-5 h-5"/></div>
                            </div>
                            <div className="text-3xl font-bold text-slate-800">{kpis.globalCouverture} <span className="text-lg font-normal text-slate-400">Jours</span></div>
                            <p className="text-xs text-slate-400 mt-2">Délai moyen réception pièce</p>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-emerald-100 break-inside-avoid">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider">Encaissement (Réel)</h3>
                                <div className="p-2 bg-emerald-50 rounded-lg text-emerald-600"><Icons.Clock className="w-5 h-5"/></div>
                            </div>
                            <div className="text-3xl font-bold text-slate-800">{kpis.globalEncaissement} <span className="text-lg font-normal text-slate-400">Jours</span></div>
                            <p className="text-xs text-slate-400 mt-2">Délai moyen valeur banque</p>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-blue-100 break-inside-avoid">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider">Volume Traité</h3>
                                <div className="p-2 bg-blue-50 rounded-lg text-blue-600"><Icons.Check className="w-5 h-5"/></div>
                            </div>
                            <div className="text-3xl font-bold text-slate-800">{formatCurrency(kpis.totalAmount)}</div>
                            <p className="text-xs text-slate-400 mt-2">Sur {kpis.count} règlements</p>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden print:border-none print:shadow-none">
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 print:bg-transparent">
                            <h3 className="font-bold text-slate-700">Détail des Règlements</h3>
                            <span className="text-xs font-mono text-slate-400 bg-white px-2 py-1 rounded border">{filteredPayments.length} écritures</span>
                        </div>
                        <table className="w-full text-sm text-left">
                            <thead className="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-100 print:bg-slate-200 print:text-black">
                                <tr>
                                    <th className="px-6 py-3">Date</th>
                                    <th className="px-6 py-3">Pièce / Libellé</th>
                                    <th className="px-6 py-3 text-right">Montant</th>
                                    <th className="px-6 py-3 text-center">Factures</th>
                                    <th className="px-6 py-3 text-center">Couverture</th>
                                    <th className="px-6 py-3 text-center">Encaissement</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {filteredPayments.map((p, idx) => (
                                    <tr key={idx} className="hover:bg-slate-50 break-inside-avoid">
                                        <td className="px-6 py-4 font-medium whitespace-nowrap">{formatDate(p.dateObj)}</td>
                                        <td className="px-6 py-4">
                                            <div className="font-bold text-slate-700">{p.piece}</div>
                                            <div className="text-xs text-slate-400 truncate max-w-[200px]">{p.libelle}</div>
                                        </td>
                                        <td className="px-6 py-4 text-right font-mono font-bold text-slate-700">{formatCurrency(p.credit)}</td>
                                        <td className="px-6 py-4 text-center">
                                            <span className="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-medium">{p.invoicesCovered.length}</span>
                                        </td>
                                        <td className="px-6 py-4 text-center">
                                            <div className="font-bold text-indigo-600">{Math.round(p.avgCouverture)} j</div>
                                        </td>
                                        <td className="px-6 py-4 text-center">
                                            <div className="font-bold text-emerald-600">{Math.round(p.avgEncaissement)} j</div>
                                        </td>
                                    </tr>
                                ))}
                                {filteredPayments.length === 0 && (
                                    <tr><td colSpan="6" className="p-8 text-center text-slate-400">Aucune donnée sur cette période.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>